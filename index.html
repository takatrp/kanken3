<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>漢検3級トレーナー r4.1（読み・送り仮名・部首／CSV強化）</title>
<style>
:root{--accent:#578899}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,"Noto Sans JP",Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f7f9fb;color:#222}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e9ef;padding:10px 12px;z-index:5}
h1{font-size:18px;margin:0;color:var(--accent)}
.wrap{max-width:860px;margin:0 auto;padding:14px}
.card{background:#fff;border:1px solid #e5e9ef;border-radius:12px;padding:14px;margin:10px 0;box-shadow:0 1px 0 rgba(0,0,0,.02)}
.row{display:flex;gap:10px;flex-wrap:wrap}
.row>*{flex:1 1 200px}
select,button,input{font-size:16px;padding:10px;border-radius:10px;border:1px solid #cfd8e3;background:#fff}
button.primary{background:var(--accent);color:#fff;border:none}
button.ghost{background:#f2f5f8}
.q-main{font-size:42px;text-align:center;letter-spacing:.04em;margin:8px 0}
.q-sub{opacity:.8;text-align:center;font-size:14px}
.ans{display:flex;gap:8px;margin-top:8px}
.muted{opacity:.75}
.pill{display:inline-block;border:1px solid #d8e2ee;border-radius:999px;padding:4px 10px;font-size:12px;margin-right:6px;background:#f7fbff}
.stats{display:flex;gap:8px;flex-wrap:wrap}
.stats .pill{background:#eef5f9}
.big{font-size:20px}
.good{color:#0a7a3c}
.bad{color:#a32626}
.center{text-align:center}
.foot{font-size:12px;opacity:.7;text-align:center;margin:8px 0}
.hidden{display:none}
.tag{font-size:11px;border:1px solid #d8e2ee;border-radius:6px;padding:2px 6px;margin-left:6px}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.progress{height:8px;border-radius:999px;background:#e8eef6;overflow:hidden}
.progress>i{display:block;height:100%;background:var(--accent);width:0%}
.choices{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
.choice{border:1px solid #cfd8e3;border-radius:10px;padding:10px;text-align:center;background:#fff}
.choice.sel{outline:3px solid var(--accent)}
label.small{font-size:12px;opacity:.8}
.badge{background:#fff3cd;border:1px solid #ffe69c}
kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#eef;padding:0 6px;border-radius:4px;border:1px solid #dde}
</style>
</head>
<body>
<header>
  <h1>漢検3級トレーナー <span class="tag">r4.1</span> <span class="tag">読み・送り仮名・部首</span></h1>
</header>

<div class="wrap">
  <div class="card">
    <div class="row">
      <div>
        <label>学習モード</label><br>
        <select id="mode">
          <option value="yomi">読み（かな入力）</option>
          <option value="okuri">送り仮名（選択）</option>
          <option value="bushu">部首名（入力）</option>
        </select>
      </div>
      <div>
        <label>出題範囲</label><br>
        <select id="range">
          <option value="all">全データ</option>
          <option value="new">苦手重点（Box1）</option>
          <option value="srs1">SRS Box1</option>
          <option value="srs2">SRS Box2</option>
          <option value="srs3">SRS Box3</option>
        </select>
      </div>
      <div class="center">
        <label>&nbsp;</label><br>
        <button class="primary" id="nextBtn">次の問題</button>
      </div>
    </div>
    <div class="stats">
      <span class="pill">本日 <b id="todayCnt">0</b></span>
      <span class="pill">正答率 <b id="acc">0%</b></span>
      <span class="pill">連続正解 <b id="streak">0</b></span>
      <span class="pill">学習中 <b id="deckSize">0</b></span>
    </div>
    <div class="progress"><i id="progBar"></i></div>
    <div class="muted mono" id="status"></div>
  </div>

  <div class="card" id="qCard">
    <div class="q-main" id="qMain">—</div>
    <div class="q-sub" id="qSub">モードに応じた指示が表示されます</div>

    <div id="choiceBox" class="choices hidden"></div>

    <div class="ans" id="ansBox">
      <input id="answer" placeholder="ここに解答（かな／部首名）" autocomplete="off" inputmode="kana">
      <button id="submitBtn" class="primary">答える</button>
      <button id="revealBtn" class="ghost">ヒント/答え</button>
    </div>
    <div id="feedback" class="center muted" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <button id="examBtn" class="ghost">検定モード（40問・200点満点）</button><br>
        <label class="small muted">合格目安：70%（140点）</label>
      </div>
      <div>
        <label class="muted">データ読み込み（JSON/CSV/TSV対応）</label><br>
        <input type="file" id="fileInput" accept=".json,.csv,.tsv,.txt">
      </div>
      <div class="center">
        <button id="resetBtn">進捗リセット</button>
      </div>
    </div>
    <details>
      <summary>CSV仕様（500問パック用）</summary>
      <pre class="mono" style="white-space:pre-wrap">
type,kanji,readings,okuri_choices,okuri_ans,bushu,ex
# 例（読み） readingsは「|」区切り。区切りに「、／/」を書いても自動で「|」に正規化。
yomi,境内,けいだい,,,,
# 例（送り仮名） 選択肢は「|」区切り。okuri_ans は必ず choices のいずれかと完全一致。
okuri,受け,,受け入れ|受入れ|受入,受け入れ,,
# 例（部首）
bushu,体,"",,,"にんべん",</pre>
      <div class="muted">※ ヘッダは自動認識。TSVも可。エンコードはUTF-8推奨。</div>
    </details>
    <div class="muted mono" id="miniLog"></div>
  </div>

  <div class="foot">
    © Matsumoto Kaikei / Kanken3 r4.1（SRS保存・CSV差替） — 参照規範：送り仮名の付け方／常用漢字表／KANJIDIC2（帰属要）
  </div>
</div>

<script>
/*** ---------- SRS／進捗 ---------- ***/
const SRS_KEY="kanken3_srs_r41"; const STATS_KEY="kanken3_stats_r41";
function todayStr(){ const d=new Date(); return d.toISOString().slice(0,10); }
function loadSRS(){ try{return JSON.parse(localStorage.getItem(SRS_KEY))||{}}catch(e){return{}} }
function saveSRS(s){ localStorage.setItem(SRS_KEY, JSON.stringify(s)); }
function loadStats(){ try{return JSON.parse(localStorage.getItem(STATS_KEY))||{r:0,w:0,st:0,td:0,date:todayStr()}}catch(e){return{r:0,w:0,st:0,td:0,date:todayStr()}} }
function saveStats(s){ localStorage.setItem(STATS_KEY, JSON.stringify(s)); }
let SRS=loadSRS(), ST=loadStats(); if(ST.date!==todayStr()){ ST.td=0; ST.date=todayStr(); saveStats(ST); }

/*** ---------- 要素参照 ---------- ***/
const $=id=>document.getElementById(id);
const els={mode:$('mode'), range:$('range'), next:$('nextBtn'),
  qMain:$('qMain'), qSub:$('qSub'), ans:$('answer'),
  sub:$('submitBtn'), rev:$('revealBtn'), fb:$('feedback'),
  acc:$('acc'), streak:$('streak'), deck:$('deckSize'),
  today:$('todayCnt'), prog:$('progBar'), log:$('miniLog'),
  exam:$('examBtn'), file:$('fileInput'), reset:$('resetBtn'),
  stat:$('status'), choice:$('choiceBox'), ansBox:$('ansBox')
};
function updateHUD(){
  const total=ST.r+ST.w||1;
  els.acc.textContent=Math.round(100*ST.r/total)+'%';
  els.streak.textContent=ST.st;
  els.today.textContent=ST.td;
  els.deck.textContent=DATA.length;
  els.prog.style.width=Math.min(100, Math.round((ST.r+ST.w)/Math.max(80,DATA.length)*100))+'%';
}
updateHUD();

/*** ---------- 出題エンジン ---------- ***/
let cur=null, exam=false, left=0, score=0;
function boxOf(id){ return SRS[id]?.box ?? 1 }
function bump(id,ok){ const b=boxOf(id); SRS[id]={box: ok? Math.min(3,b+1):1, last:Date.now()}; saveSRS(SRS); }
function poolByRange(){
  let pool = DATA.map((d,i)=>({...d,__id:i}));
  const rg=els.range.value;
  if(rg==='srs1'||rg==='srs2'||rg==='srs3'){ const t=Number(rg.slice(3)); pool=pool.filter(d=>boxOf(d.__id)===t); }
  else if(rg==='new'){ pool=pool.filter(d=>boxOf(d.__id)===1); }
  if(pool.length===0) pool = DATA.map((d,i)=>({...d,__id:i}));
  return pool.map(p=>({p,w:(4-boxOf(p.__id))})); // Box1重め
}
function pick(){
  const pool=poolByRange(); const sum=pool.reduce((a,c)=>a+c.w,0)||1;
  let r=Math.random()*sum; for(const it of pool){ if((r-=it.w)<=0) return it.p; }
  return pool[0].p;
}

/*** ---------- 出題描画 ---------- ***/
function setQuestion(){
  const mode=els.mode.value;
  // モードに該当するデータがない場合のガード
  if(!DATA.some(d=>d.type===mode)){
    els.qMain.textContent='データがありません';
    els.qSub.textContent='このモードの行（type='+mode+'）がCSVに含まれているか確認してください';
    els.answer?.focus(); return;
  }
  cur=pick(); els.ans.value=""; els.fb.textContent=""; els.choice.classList.add('hidden'); els.ansBox.classList.remove('hidden');
  if(mode==='yomi'){
    const base=(cur.type==='yomi'?cur:pickType('yomi'));
    els.qMain.textContent=base.kanji||'—'; els.qSub.textContent='読み（かな）を入力'; cur=base;
  }else if(mode==='okuri'){
    const base=(cur.type==='okuri'?cur:pickType('okuri'));
    els.qMain.textContent = `${base.kanji}（送り仮名）`;
    els.qSub.textContent='正しい表記を選択';
    showChoices(shuffle(base.okuri_choices)); cur=base;
  }else if(mode==='bushu'){
    const base=(cur.type==='bushu'?cur:pickType('bushu'));
    els.qMain.textContent=base.kanji; els.qSub.textContent='部首名を入力（例：にんべん／てへん／さんずい…）'; cur=base;
  }
  els.ans.focus();
}
function pickType(t){ const list=DATA.map((d,i)=>({...d,__id:i})).filter(d=>d.type===t); return list.length? list[Math.floor(Math.random()*list.length)] : {type:t,kanji:"（データ不足）"}; }

/*** ---------- 選択肢UI ---------- ***/
function showChoices(arr){
  els.choice.innerHTML=''; els.choice.classList.remove('hidden'); els.ansBox.classList.add('hidden');
  arr.forEach((c)=>{
    const btn=document.createElement('button'); btn.type='button'; btn.className='choice'; btn.textContent=c;
    btn.onclick=()=>{ document.querySelectorAll('.choice').forEach(x=>x.classList.remove('sel')); btn.classList.add('sel'); check(c); };
    els.choice.appendChild(btn);
  });
}

/*** ---------- 判定 ---------- ***/
// カタカナ→ひらがな（修正版 -0x60）、空白除去
function normKana(s){ return (s||'').trim().replace(/\s+/g,'').replace(/[ァ-ン]/g, ch=>String.fromCharCode(ch.charCodeAt(0)-0x60)); }
const BUSHU_SYNONYM = new Map([
  ['にんべん',['にんべん','イ偏','イへん','亻']],
  ['てへん',['てへん','手偏','扌']],
  ['さんずい',['さんずい','氵']],
  ['きへん',['きへん','木偏']],
  ['くさかんむり',['くさかんむり','艹']],
  ['かねへん',['かねへん','金偏','釒']],
  ['くちへん',['くちへん','口偏']],
  ['りっしんべん',['りっしんべん','忄','心偏']],
  ['ひへん',['ひへん','火偏','灬']],
  ['こざとへん',['こざとへん','阝']],
  ['しんにょう',['しんにょう','辶','⻌','⻍']],
  ['つちへん',['つちへん','土偏']],
  ['やまへん',['やまへん','山偏']],
  ['あめかんむり',['あめかんむり','雨冠']],
  ['うかんむり',['うかんむり','宀']],
  ['いとへん',['いとへん','糸偏','糹']],
  ['しめすへん',['しめすへん','ネ偏','示偏']],
  ['ころもへん',['ころもへん','衤']],
]);
function isBushuOK(input, target){
  const n=(input||'').trim();
  if(!n||!target) return false;
  const cand = BUSHU_SYNONYM.get(target)||[target];
  return cand.some(x=>n===x);
}
function check(selected=null){
  if(!cur) return; const m=els.mode.value;
  let ok=false, corr="";
  if(m==='yomi'){
    corr=(cur.readings||[]).join(' / ');
    ok=(cur.readings||[]).some(y=>normKana(els.ans.value)===normKana(y));
  }else if(m==='okuri'){
    corr=cur.okuri_ans; ok=(selected===cur.okuri_ans);
  }else if(m==='bushu'){
    corr=cur.bushu||'（未設定）'; ok=isBushuOK(els.ans.value.trim(), cur.bushu);
  }
  bump(cur.__id??cur.kanji, ok);
  if(ok){ els.fb.innerHTML=`<span class="good big">◎ 正解！</span> <span class="pill">正：${corr}</span>`; ST.r++; ST.st++; ST.td++; if(exam){ score+=5; left--; } }
  else { els.fb.innerHTML=`<span class="bad big">× 不正解</span> <span class="pill badge">正：${corr||'—'}</span>`; ST.w++; ST.st=0; ST.td++; if(exam){ left--; } }
  saveStats(ST); updateHUD();
  if(exam){
    els.stat.textContent=`検定モード：残り${left}問／得点${score}（200点満点）`;
    if(left<=0){ exam=false; const pct=Math.round((score/200)*100); els.fb.innerHTML+=`<div class="center" style="margin-top:8px"><b>終了！</b> ${score}/200（${pct}%）</div>`; }
  }
}

/*** ---------- 操作 ---------- ***/
els.next.onclick=setQuestion;
els.submitBtn.onclick=()=>check();
els.revealBtn.onclick=()=>{
  if(!cur) return;
  const m=els.mode.value;
  if(m==='yomi'){ els.fb.innerHTML=`<span class="pill">読み：<b>${(cur.readings||[]).join(' / ')}</b></span>`; }
  else if(m==='okuri'){ els.fb.innerHTML=`<span class="pill">正：<b>${cur.okuri_ans}</b></span>`; }
  else if(m==='bushu'){ els.fb.innerHTML=`<span class="pill">部首：<b>${cur.bushu||'（未）'}</b></span>`; }
};
els.ans.addEventListener('keydown',e=>{ if(e.key==='Enter') check(); });
els.exam.onclick=()=>{ exam=true; left=40; score=0; els.stat.textContent='検定モード開始（40問）'; setQuestion(); };

/*** ---------- CSV/JSONハンドラ（堅牢化版） ---------- ***/
function parseCSV(text){
  // 改行（CRLF/CR/LF）＆コメント(#)除去
  const lines=text.split(/\r\n|\n|\r/).filter(x=>x.trim()!=='' && !x.trim().startsWith('#'));
  const arr=[];
  for(const ln of lines){
    // TSVのみ→カンマに変換
    const line = ln.includes('\t') && !ln.includes(',') ? ln.replace(/\t/g,',') : ln;
    const cols=splitCSV(line);
    // ヘッダ自動スキップ
    if(/^type\s*$/i.test((cols[0]||'').trim())) continue;
    const [type,kanji,readings,okuri_choices,okuri_ans,bushu,ex]=cols;
    // readings/choices の区切り揺れを | に正規化（、／/）
    const rnorm=(readings||'').replace(/[、／/]/g,'|');
    const cnorm=(okuri_choices||'').replace(/[、／/]/g,'|');
    arr.push({
      type:(type||'').trim().toLowerCase(),
      kanji:(kanji||'').trim(),
      readings:rnorm.split('|').map(s=>s.trim()).filter(Boolean),
      okuri_choices:cnorm.split('|').map(s=>s.trim()).filter(Boolean),
      okuri_ans:(okuri_ans||'').trim(),
      bushu:(bushu||'').trim(),
      ex:(ex||'').trim()
    });
  }
  return arr;
}
function splitCSV(line){
  // シンプルCSV（"で囲まれたカンマと二重引用対応）
  const out=[]; let cur=''; let q=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='\"'){ if(q && line[i+1]==='\"'){ cur+='\"'; i++; } else { q=!q; } }
    else if(ch===',' && !q){ out.push(cur); cur=''; }
    else cur+=ch;
  }
  out.push(cur); return out;
}
function summarizeLoadedData(){
  const y=DATA.filter(d=>d.type==='yomi').length;
  const o=DATA.filter(d=>d.type==='okuri').length;
  const b=DATA.filter(d=>d.type==='bushu').length;
  const bad=DATA.filter(d=>!['yomi','okuri','bushu'].includes(d.type)).slice(0,3);
  els.log.textContent=`読込：合計${DATA.length}件（読み${y}・送り${o}・部首${b}）` +
    (bad.length? `／不明type先頭: ${bad.map(x=>x.type||'(空)').join(', ')}`:'');
}
els.file.onchange=async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const txt=await f.text();
    if(f.name.endsWith('.json')){ DATA=JSON.parse(txt); }
    else{ DATA=parseCSV(txt); }
    // 進捗リセット
    localStorage.removeItem(SRS_KEY); localStorage.removeItem(STATS_KEY);
    SRS={}; ST={r:0,w:0,st:0,td:0,date:todayStr()}; saveStats(ST);
    updateHUD(); summarizeLoadedData(); setQuestion();
  }catch(err){ els.log.textContent='読込エラー：'+err.message; }
};

/*** ---------- util ---------- ***/
function shuffle(a){ return a.map(v=>[Math.random(),v]).sort((x,y)=>x[0]-y[0]).map(x=>x[1]); }

/*** ---------- 内蔵スターターパック（最小・動作確認用） ---------- ***/
let DATA = [
  // 読み（サンプル）
  {type:"yomi", kanji:"安全", readings:["あんぜん"]},
  {type:"yomi", kanji:"影響", readings:["えいきょう"]},
  {type:"yomi", kanji:"家族", readings:["かぞく"]},
  {type:"yomi", kanji:"経済", readings:["けいざい"]},
  // 送り仮名（サンプル）
  {type:"okuri", kanji:"受け", okuri_choices:["受け入れ","受入れ","受入"], okuri_ans:"受け入れ"},
  {type:"okuri", kanji:"申し", okuri_choices:["申し込む","申込む"], okuri_ans:"申し込む"},
  // 部首（サンプル）
  {type:"bushu", kanji:"海", bushu:"さんずい"},
  {type:"bushu", kanji:"体", bushu:"にんべん"},
];
updateHUD(); setQuestion();
</script>
</body>
</html>
